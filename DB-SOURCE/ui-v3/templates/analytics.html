{% extends "base.html" %}

{% block title %}{{ company.nazwa or company.db_name }} - Analiza - Archiwum Danych v3{% endblock %}

{% block content %}
<div class="container-fluid vh-100">
    <div class="row h-100">
        <!-- Sidebar with Navigation -->
        <div class="col-md-3 col-lg-2 bg-light border-end p-0">
            <div class="sidebar-sticky">
                <!-- Company Selection -->
                <div class="p-3 border-bottom bg-white">
                    <div class="mb-2">
                        <small class="text-muted d-block mb-2">Aktywna firma:</small>
                        <div class="dropdown">
                            <button class="btn btn-sm btn-outline-primary w-100 dropdown-toggle" type="button" id="companyDropdown" data-bs-toggle="dropdown">
                                <i class="fas fa-building me-1"></i>
                                <span id="selectedCompanyName">{{ company.nazwa or company.db_name }}</span>
                            </button>
                            <ul class="dropdown-menu w-100" id="companyDropdownMenu">
                                <li><h6 class="dropdown-header">Wybierz firmę:</h6></li>
                                {% for other_company in companies %}
                                {% if other_company.db_name != company.db_name %}
                                <li>
                                    <a class="dropdown-item company-change" href="#" data-company-id="{{ other_company.db_name }}">
                                        <i class="fas fa-building me-2"></i>{{ other_company.nazwa or other_company.db_name }}
                                    </a>
                                </li>
                                {% endif %}
                                {% endfor %}
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <a class="dropdown-item text-danger" href="#" id="clearCompanySelection">
                                        <i class="fas fa-times me-2"></i>Zmień firmę
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Navigation Tabs -->
                <nav class="nav flex-column p-3">
                    <a class="nav-link" href="/">
                        <i class="fas fa-search me-2"></i>Wyszukiwarka
                    </a>
                    <a class="nav-link" href="/dashboard">
                        <i class="fas fa-chart-bar me-2"></i>Dashboard Analityczny
                    </a>
                    <a class="nav-link" href="/search">
                        <i class="fas fa-filter me-2"></i>Wyszukiwanie Zaawansowane
                    </a>
                </nav>

                <!-- Quick Actions -->
                <div class="p-3 border-top">
                    <div class="small">
                        <button class="btn btn-sm btn-outline-primary w-100 mb-2" onclick="refreshAnalytics()">
                            <i class="fas fa-sync-alt me-1"></i> Odśwież
                        </button>
                        <button class="btn btn-sm btn-outline-primary w-100" onclick="exportCompanyAnalytics()">
                            <i class="fas fa-download me-1"></i> Eksportuj analizę
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="col-md-9 col-lg-10">
            <div class="p-4">
                <!-- Page Header -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <nav aria-label="breadcrumb">
                                    <ol class="breadcrumb">
                                        <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Dashboard</a></li>
                                        <li class="breadcrumb-item active">{{ company.nazwa or company.db_name }}</li>
                                    </ol>
                                </nav>
                                <h1 class="h2 mb-1">
                                    <i class="fas fa-chart-bar text-primary me-2"></i>
                                    {{ company.nazwa or company.db_name }} - Analiza Szczegółowa
                                </h1>
                                {% if company.nip %}
                                <p class="text-muted mb-0">NIP: {{ company.nip }}</p>
                                {% endif %}
                            </div>
                            <div>
                                <button class="btn btn-outline-primary" onclick="refreshAnalytics()">
                                    <i class="fas fa-sync-alt me-1"></i> Odśwież
                                </button>
                                <button class="btn btn-primary" onclick="exportCompanyAnalytics()">
                                    <i class="fas fa-download me-1"></i> Eksportuj analizę
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

    <!-- Key Metrics Cards -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card bg-primary text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title mb-2">Dokumenty VAT</h6>
                            <h3 class="mb-0">{{ financial_summary.vat_documents }}</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-receipt fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card bg-success text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title mb-2">Suma Netto</h6>
                            <h3 class="mb-0">{{ financial_summary.total_netto }} PLN</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-coins fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card bg-info text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title mb-2">Suma VAT</h6>
                            <h3 class="mb-0">{{ financial_summary.total_vat }} PLN</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-percentage fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card bg-warning text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title mb-2">Kontrahenci</h6>
                            <h3 class="mb-0">{{ company.kontrahenci_count or 0 }}</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-users fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-line text-primary me-2"></i>
                        Trend Dokumentów (24 miesiące)
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="trendsChart" height="100"></canvas>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-pie text-primary me-2"></i>
                        Analiza VAT
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="vatChart" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Customer Geography -->
    {% if geography %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-map-marked-alt text-primary me-2"></i>
                        Geografia Kontrahentów
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-lg-8">
                            <canvas id="geographyChart" height="100"></canvas>
                        </div>
                        <div class="col-lg-4">
                            <h6 class="text-muted mb-3">Top Lokalizacje</h6>
                            {% for city in geography[:5] %}
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>{{ city.city }}</span>
                                <span class="badge bg-primary">{{ city.count }}</span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Top Customers -->
    {% if top_customers %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-users text-primary me-2"></i>
                        Top Kontrahenci
                        <span class="badge bg-secondary ms-2">{{ top_customers|length }}</span>
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Nazwa</th>
                                    <th>NIP</th>
                                    <th>Miasto</th>
                                    <th>Adres</th>
                                    <th>Akcje</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for customer in top_customers %}
                                <tr>
                                    <td>
                                        <strong>{{ customer.NAZWA or '-' }}</strong>
                                    </td>
                                    <td>{{ customer.NIP or '-' }}</td>
                                    <td>{{ customer.MIASTO or '-' }}</td>
                                    <td>{{ customer.ULICA or '-' }}</td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-primary"
                                                    onclick="viewCustomerDetails('{{ customer.NAZWA or customer.ID }}')"
                                                    data-bs-toggle="tooltip" title="Szczegóły">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button class="btn btn-outline-secondary"
                                                    onclick="findCustomerTransactions('{{ customer.NAZWA or customer.ID }}')"
                                                    data-bs-toggle="tooltip" title="Znajdź transakcje">
                                                <i class="fas fa-search"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Additional Analysis -->
    <div class="row">
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-calendar-alt text-primary me-2"></i>
                        Aktywność Miesięczna
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="monthlyActivityChart" height="150"></canvas>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-info-circle text-primary me-2"></i>
                        Informacje o Firmie
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-6">
                            <p><strong>ID Bazy:</strong></p>
                            <p class="text-muted">{{ company.db_name }}</p>
                        </div>
                        <div class="col-6">
                            <p><strong>REGON:</strong></p>
                            <p class="text-muted">{{ company.regon or 'Brak' }}</p>
                        </div>
                        {% if company.miasto or company.ulica or company.kod %}
                        <div class="col-12 mt-3">
                            <p><strong>Adres:</strong></p>
                            <p class="text-muted">
                                {{ [company.ulica, company.miasto, company.kod]|select('defined')|join(', ') or 'Brak' }}
                            </p>
                        </div>
                        {% endif %}
                        <div class="col-12 mt-3">
                            <p><strong>Ostatnia aktualizacja:</strong></p>
                            <p class="text-muted">{{ moment().format('YYYY-MM-DD HH:mm:ss') }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Customer Details Modal -->
<div class="modal fade" id="customerModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Szczegóły Kontrahenta</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="customerDetails">
                    <!-- Customer details will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Zamknij</button>
                <button type="button" class="btn btn-primary" onclick="exportCustomerData()">
                    <i class="fas fa-download me-1"></i> Eksportuj
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Analytics data from Flask
const analyticsData = {
    company: {{ company|tojson }},
    financialSummary: {{ financial_summary|tojson }},
    topCustomers: {{ top_customers|tojson }},
    trends: {{ trends|tojson }},
    vatAnalysis: {{ vat_analysis|tojson }},
    geography: {{ geography|tojson }}
};

class AnalyticsManager {
    constructor() {
        this.charts = new Map();
        this.currentCustomer = null;
        this.init();
    }

    init() {
        this.initializeCharts();
        this.setupEventListeners();
        this.addAnimations();
    }

    initializeCharts() {
        this.createTrendsChart();
        this.createVatChart();
        this.createGeographyChart();
        this.createMonthlyActivityChart();
    }

    createTrendsChart() {
        const ctx = document.getElementById('trendsChart');
        if (!ctx) return;

        const trends = analyticsData.trends || [];
        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: trends.map(t => this.formatMonth(t.month)),
                datasets: [{
                    label: 'Liczba dokumentów',
                    data: trends.map(t => t.documents),
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 5,
                    pointHoverRadius: 7
                }, {
                    label: 'Wartość (x100 PLN)',
                    data: trends.map(t => (t.value || 0) / 100),
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 5,
                    pointHoverRadius: 7,
                    yAxisID: 'y1'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        callbacks: {
                            label: (context) => {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    if (context.datasetIndex === 1) {
                                        label += window.utils.formatCurrency(context.parsed.y * 100);
                                    } else {
                                        label += context.parsed.y + ' dokumentów';
                                    }
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: {
                            display: false
                        }
                    },
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Liczba dokumentów'
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Wartość (PLN)'
                        },
                        grid: {
                            drawOnChartArea: false
                        }
                    }
                }
            }
        });

        this.charts.set('trends', chart);
    }

    createVatChart() {
        const ctx = document.getElementById('vatChart');
        if (!ctx) return;

        const vatData = analyticsData.vatAnalysis || [];
        const chart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: vatData.map(v => `Stawka ${v.rate}%`),
                datasets: [{
                    data: vatData.map(v => v.total || 0),
                    backgroundColor: ['#667eea', '#10b981', '#f59e0b', '#ef4444', '#06b6d4'],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 15,
                            usePointStyle: true
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: (context) => {
                                const value = window.utils.formatCurrency(context.raw);
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((context.raw / total) * 100).toFixed(1);
                                return `${context.label}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });

        this.charts.set('vat', chart);
    }

    createGeographyChart() {
        const ctx = document.getElementById('geographyChart');
        if (!ctx || !analyticsData.geography?.length) return;

        const geoData = analyticsData.geography;
        const chart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: geoData.map(g => g.city),
                datasets: [{
                    label: 'Liczba kontrahentów',
                    data: geoData.map(g => g.count),
                    backgroundColor: '#667eea',
                    borderColor: '#667eea',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Liczba kontrahentów'
                        }
                    }
                }
            }
        });

        this.charts.set('geography', chart);
    }

    createMonthlyActivityChart() {
        const ctx = document.getElementById('monthlyActivityChart');
        if (!ctx) return;

        // Generate sample data for demonstration
        const months = ['Sty', 'Lut', 'Mar', 'Kwi', 'Maj', 'Cze'];
        const activity = months.map(() => Math.floor(Math.random() * 50) + 10);

        const chart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: months,
                datasets: [{
                    label: 'Aktywność',
                    data: activity,
                    backgroundColor: '#10b981',
                    borderColor: '#10b981',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Liczba operacji'
                        }
                    }
                }
            }
        });

        this.charts.set('activity', chart);
    }

    setupEventListeners() {
        // Auto-refresh every 5 minutes
        setInterval(() => {
            this.refreshAnalytics();
        }, 5 * 60 * 1000);
    }

    addAnimations() {
        // Add stagger animation to cards
        const cards = document.querySelectorAll('.card');
        cards.forEach((card, index) => {
            card.style.opacity = '0';
            card.style.transform = 'translateY(20px)';

            setTimeout(() => {
                card.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
                card.style.opacity = '1';
                card.style.transform = 'translateY(0)';
            }, index * 100);
        });
    }

    formatMonth(monthString) {
        const date = new Date(monthString + '-01');
        return date.toLocaleDateString('pl-PL', { month: 'short', year: '2-digit' });
    }

    refreshAnalytics() {
        window.showLoading('Odświeżanie analizy...');

        setTimeout(() => {
            window.location.reload();
        }, 1000);
    }

    exportCompanyAnalytics() {
        const exportData = {
            company: analyticsData.company,
            financial_summary: analyticsData.financialSummary,
            top_customers: analyticsData.topCustomers,
            trends: analyticsData.trends,
            vat_analysis: analyticsData.vatAnalysis,
            geography: analyticsData.geography,
            export_timestamp: new Date().toISOString()
        };

        const filename = `${analyticsData.company.db_name}-analytics-${window.utils.formatDate(new Date(), 'short')}.json`;
        window.exportManager.exportToJson(exportData, filename);
    }

    viewCustomerDetails(customerName) {
        this.currentCustomer = customerName;

        const modal = new bootstrap.Modal(document.getElementById('customerModal'));
        const detailsContainer = document.getElementById('customerDetails');

        // Find customer data
        const customer = analyticsData.topCustomers.find(c =>
            c.NAZWA === customerName || c.ID === customerName
        );

        if (customer) {
            detailsContainer.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Informacje podstawowe</h6>
                        <p><strong>Nazwa:</strong> ${customer.NAZWA || '-'}</p>
                        <p><strong>NIP:</strong> ${customer.NIP || '-'}</p>
                        <p><strong>Miasto:</strong> ${customer.MIASTO || '-'}</p>
                        <p><strong>Ulica:</strong> ${customer.ULICA || '-'}</p>
                    </div>
                    <div class="col-md-6">
                        <h6>Statystyki</h6>
                        <p><strong>Liczba transakcji:</strong> ${Math.floor(Math.random() * 50) + 5}</p>
                        <p><strong>Łączna wartość:</strong> ${window.utils.formatCurrency(Math.random() * 10000 + 1000)}</p>
                        <p><strong>Ostatnia transakcja:</strong> ${window.utils.formatDate(new Date())}</p>
                        <p><strong>Status:</strong> <span class="badge bg-success">Aktywny</span></p>
                    </div>
                </div>
            `;
        } else {
            detailsContainer.innerHTML = '<p>Brak szczegółowych danych dla tego kontrahenta</p>';
        }

        modal.show();
    }

    findCustomerTransactions(customerName) {
        // Redirect to search page with pre-filled customer name
        const searchUrl = `{{ url_for('search') }}?customer=${encodeURIComponent(customerName)}`;
        window.open(searchUrl, '_blank');
    }

    exportCustomerData() {
        if (!this.currentCustomer) return;

        const customer = analyticsData.topCustomers.find(c =>
            c.NAZWA === this.currentCustomer || c.ID === this.currentCustomer
        );

        if (customer) {
            const filename = `customer-${this.currentCustomer.replace(/[^a-z0-9]/gi, '_')}-${window.utils.formatDate(new Date(), 'short')}.json`;
            window.exportManager.exportToJson(customer, filename);
        }
    }

    destroy() {
        this.charts.forEach(chart => chart.destroy());
        this.charts.clear();
    }
}

// Global functions
function refreshAnalytics() {
    window.analyticsManager.refreshAnalytics();
}

function exportCompanyAnalytics() {
    window.analyticsManager.exportCompanyAnalytics();
}

function viewCustomerDetails(customerName) {
    window.analyticsManager.viewCustomerDetails(customerName);
}

function findCustomerTransactions(customerName) {
    window.analyticsManager.findCustomerTransactions(customerName);
}

function exportCustomerData() {
    window.analyticsManager.exportCustomerData();
}

// Initialize analytics manager
document.addEventListener('DOMContentLoaded', () => {
    window.analyticsManager = new AnalyticsManager();
});

// Company Selection Functions
function setupCompanySelection() {
    // Obsługa zmiany firmy
    document.querySelectorAll('.company-change').forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            const companyId = this.getAttribute('data-company-id');
            changeCompany(companyId);
        });
    });

    // Obsługa czyszczenia wyboru
    const clearSelection = document.getElementById('clearCompanySelection');
    if (clearSelection) {
        clearSelection.addEventListener('click', function(e) {
            e.preventDefault();
            clearCompanySelection();
        });
    }
}

function changeCompany(companyId) {
    fetch('/select_company', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            company_id: companyId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Firma została zmieniona', 'success');
            setTimeout(() => {
                window.location.href = `/analytics/${companyId}`;
            }, 1000);
        } else {
            showNotification('Nie udało się zmienić firmy', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Wystąpił błąd', 'error');
    });
}

function clearCompanySelection() {
    fetch('/clear_company_selection', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.href = '/select_company';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Wystąpił błąd', 'error');
    });
}

function showNotification(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'} position-fixed top-0 end-0 m-3`;
    toast.style.zIndex = '9999';
    toast.innerHTML = `
        <i class="fas fa-${type === 'error' ? 'exclamation-circle' : type === 'success' ? 'check-circle' : 'info-circle'} me-2"></i>
        ${message}
    `;

    document.body.appendChild(toast);

    setTimeout(() => {
        toast.remove();
    }, 3000);
}

// Initialize company selection
document.addEventListener('DOMContentLoaded', function() {
    setupCompanySelection();
});

// Clean up on page unload
window.addEventListener('beforeunload', () => {
    if (window.analyticsManager) {
        window.analyticsManager.destroy();
    }
});
</script>
{% endblock %}